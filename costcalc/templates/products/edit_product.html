{% extends 'base.html' %}
{% from 'bootstrap5/form.html' import render_form %}

{% block content %}
<div class="container">
    <h3>编辑产品</h3>
    <form method="post" action="{{ url_for('products.edit_product', product_id=product.id) }}">
        {{ form.hidden_tag() }}
        
        <!-- 产品信息表单字段 -->
        <div class="form-row">
            <div class="form-group col-md-3">
                {{ form.name.label(class="form-label") }}
                {{ form.name(class="form-control") }}
            </div>
        </div>
        <hr />
        
        <!-- 动态材料表单 -->
        <div class="d-flex justify-content-between align-items-center my-3">
            <h5 class="mb-0">材料</h5>
            <button type="button" class="btn btn-primary btn-sm" onclick="addPMForm()">+</button>
        </div>
        <div id="pmforms-container">
            {% for pmform in pmforms %}
            <div class="form-row align-items-center mb-3 position-relative" data-material-id="{{ pmform.materialID.data }}">
                <div class="form-group col-md-3">
                    {{ pmform.material_name.label(class="form-label") }}
                    {{ pmform.material_name(class="form-control") }}
                </div>
                <div class="form-group col-md-2">
                    {{ pmform.net_weight.label(class="form-label") }}
                    {{ pmform.net_weight(class="form-control") }}
                </div>
                <div class="form-group col-md-2">
                    {{ pmform.gross_weight.label(class="form-label") }}
                    {{ pmform.gross_weight(class="form-control") }}
                </div>
                <div class="form-group col-md-2">
                    {{ pmform.qualification_rate.label(class="form-label") }}
                    {{ pmform.qualification_rate(class="form-control") }}
                </div>
                <div class="form-group col-md-2">
                    <button type="button" class="btn btn-danger btn-sm position-absolute"  onclick="removeForm(this)">-</button>
                </div>
            </div>
            {% endfor %}
        </div>
        <hr/>
        
        <!-- 动态人工表单 -->
        <div class="d-flex justify-content-between align-items-center my-3">
            <h5 class="mb-0">人工</h5>
            <button type="button" class="btn btn-primary btn-sm" onclick="addPLForm()">+</button>
        </div>
        <div id="plforms-container">
            {% for plform in plforms %}
            <div class="form-row align-items-center mb-3 position-relative" data-labor-id="{{ plform.laborID.data }}">
                <div class="form-group col-md-3">
                    {{ plform.labor_name.label(class="form-label") }}
                    {{ plform.labor_name(class="form-control") }}
                </div>
                <div class="form-group col-md-2">
                    {{ plform.process_time.label(class="form-label") }}
                    {{ plform.process_time(class="form-control") }}
                </div>
                <div class="form-group col-md-2">
                    {{ plform.capacity.label(class="form-label") }}
                    {{ plform.capacity(class="form-control") }}
                </div>
                <div class="form-group col-md-2">
                    {{ plform.qualification_rate.label(class="form-label") }}
                    {{ plform.qualification_rate(class="form-control") }}
                </div>
                <div class="form-group col-md-2">
                    <button type="button" class="btn btn-danger btn-sm position-absolute"  onclick="removeForm(this)">-</button>
                </div>
            </div>
            {% endfor %}
        </div>
        <hr/>
        
        <!-- 运输费 -->
        <h5>运输</h5>
        <div class="form-row">
            <div class="form-group col-md-3">
                {{ form.trans_method.label(class="form-label") }}
                {{ form.trans_method(class="form-control") }}
            </div>
            <div class="form-group col-md-3">
                {{ form.trans_dest.label(class="form-label") }}
                {{ form.trans_dest(class="form-control") }}
            </div>
            <div class="form-group col-md-3">
                {{ form.trans_cost_kg.label(class="form-label") }}
                {{ form.trans_cost_kg(class="form-control") }}
            </div>
            
        </div>
        <hr/>

        <!-- 提交按钮 -->
        <div class="form-row">
            <div class="col text-right">
                <button type="submit" class="btn btn-primary">提交</button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    let pmFormCounter = {{ pmforms|length }};
    let plFormCounter = {{ plforms|length }};

    function addPMForm() {
        const container = document.getElementById('pmforms-container');
        fetch("{{ url_for('products.new_pmform') }}")
            .then(response => response.text())
            .then(html => {
                pmFormCounter++;
                const newForm = document.createElement('div');
                newForm.innerHTML = html.replace(/__prefix__/g, pmFormCounter);

                // 设置select框的默认值为空
                const newSelect = newForm.querySelector('select[name$="-material_choices"]');
                newSelect.value = "";  // 设置默认值为空

                // 添加change事件监听器
                newSelect.addEventListener('change', checkDuplicateMaterials);

                container.appendChild(newForm);
            })
            .catch(error => console.error('Error:', error));
    }

    function addPLForm() {
        const container = document.getElementById('plforms-container');
        fetch("{{ url_for('products.new_plform') }}")
            .then(response => response.text())
            .then(html => {
                plFormCounter++;
                const newForm = document.createElement('div');
                newForm.innerHTML = html.replace(/__prefix__/g, plFormCounter);

                // 设置select框的默认值为空
                const newSelect = newForm.querySelector('select[name$="-labor_choices"]');
                newSelect.value = "";  // 设置默认值为空

                // 添加change事件监听器
                newSelect.addEventListener('change', checkDuplicateLabors);

                container.appendChild(newForm);
            })
            .catch(error => console.error('Error:', error));
    }

    function checkDuplicateMaterials(event) {
        const selectedMaterials = Array.from(document.querySelectorAll('select[name$="-material_choices"]')).map(select => select.value);
        const currentSelect = event.target;
        const currentValue = currentSelect.value;

        // 检查是否有重复项
        const isDuplicate = selectedMaterials.filter(value => value === currentValue).length > 1;
        if (isDuplicate) {
            alert('不能添加相同的材料');
            currentSelect.value = ""; // 重置选择框
        }
    }

    function checkDuplicateLabors(event) {
        const selectedLabors = Array.from(document.querySelectorAll('select[name$="-labor_choices"]')).map(select => select.value);
        const currentSelect = event.target;
        const currentValue = currentSelect.value;

        // 检查是否有重复项
        const isDuplicate = selectedLabors.filter(value => value === currentValue).length > 1;
        if (isDuplicate) {
            alert('不能添加相同的工序');
            currentSelect.value = ""; // 重置选择框
        }
    }

    function removeForm(button) {
        const formRow = button.closest('.form-row');
        const productId = {{ product.id|tojson|safe }};
        const materialId = formRow.getAttribute('data-material-id');
        const laborId = formRow.getAttribute('data-labor-id');

        if (materialId || laborId) {
            // 如果是旧表单，发送删除请求到后端
            if (confirm('Are you sure you want to delete this item?')) {
                const url = materialId ? 
                    `/product/${productId}/material/${materialId}/delete` :
                    `/product/${productId}/labor/${laborId}/delete`;

                fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        formRow.remove();
                    } else {
                        alert('Failed to delete the item.');
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        } else {
            // 如果是新表单，直接删除DOM元素
            formRow.remove();
        }
    }

</script>
{% endblock %}