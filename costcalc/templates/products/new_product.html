{% extends 'base.html' %}

{% block content %}
<div class="container">
    <form method="post" action="{{ url_for('products.new_product') }}" id="product-form">
        {{ form.hidden_tag() }}

        <!-- 产品名称字段 -->
        <div class="form-row">
            <div class="form-group col-md-2">
                <h5>{{ form.name.label(class="form-label") }}</h5>
                {{ form.name(class="form-control") }}
            </div>
        </div>
        <hr />

        <!-- 动态材料表单 -->
        <div class="d-flex justify-content-between align-items-center my-3">
            <h5 class="mb-0">材料</h5>
            <button type="button" class="btn btn-primary btn-sm" onclick="addPMForm()">+</button>
        </div>
        <div id="pmforms-container"></div>
        <hr/>


        <!-- 动态人工表单 -->
        <div class="d-flex justify-content-between align-items-center my-3">
            <h5 class="mb-0">人工</h5>
            <button type="button" class="btn btn-primary btn-sm"  onclick="addPLForm()">+</button>
        </div>
        <div id="plforms-container"></div>
        <hr />

        <!-- 运输费用字段 -->
        <h5>运输</h5>
        <div class="form-row">
            <div class="form-group col-md-2">
                {{ form.trans_method.label(class="form-label") }}
                {{ form.trans_method(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.trans_dest.label(class="form-label") }}
                {{ form.trans_dest(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.trans_cost_kg.label(class="form-label") }}
                {{ form.trans_cost_kg(class="form-control") }}
            </div>
        </div>
        <hr/>
        <!-- 系数字段 -->
        <h5>系数</h5>
        <div class="form-row">
            <div class="form-group col-md-2">
                {{ form.dev_coef.label(class="form-label") }}
                {{ form.dev_coef(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.fac_coef.label(class="form-label") }}
                {{ form.fac_coef(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.admin_coef.label(class="form-label") }}
                {{ form.admin_coef(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.sale_coef.label(class="form-label") }}
                {{ form.sale_coef(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.finance_coef.label(class="form-label") }}
                {{ form.finance_coef(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.tax_coef.label(class="form-label") }}
                {{ form.tax_coef(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.profit_coef.label(class="form-label") }}
                {{ form.profit_coef(class="form-control") }}
            </div>
        </div>
        <hr/>
        <!-- 提交按钮 -->
        <div class="col text-right">
            <button type="submit" class="btn btn-primary">提交</button>
        </div>
    </form>
</div>
{% endblock %}


{% block scripts %}
{{ super() }}
<script>
    let pmFormCounter = 0;
    let plFormCounter = 0;

    function addPMForm() {
        const container = document.getElementById('pmforms-container');
        fetch("{{ url_for('products.new_pmform') }}")
            .then(response => response.text())
            .then(html => {
                pmFormCounter++;
                const newForm = document.createElement('div');
                newForm.innerHTML = html.replace(/__prefix__/g, pmFormCounter);

                // 设置select框的默认值为空
                const newSelect = newForm.querySelector('select[name$="-material_choices"]');
                newSelect.value = "";  // 设置默认值为空

                // 添加change事件监听器
                newSelect.addEventListener('change', checkDuplicateMaterials);

                container.appendChild(newForm);
            })
            .catch(error => console.error('Error:', error));
    }

    function addPLForm() {
        const container = document.getElementById('plforms-container');
        fetch("{{ url_for('products.new_plform') }}")
            .then(response => response.text())
            .then(html => {
                plFormCounter++;
                const newForm = document.createElement('div');
                newForm.innerHTML = html.replace(/__prefix__/g, plFormCounter);

                // 设置select框的默认值为空
                const newSelect = newForm.querySelector('select[name$="-labor_choices"]');
                newSelect.value = "";  // 设置默认值为空

                // 添加change事件监听器
                newSelect.addEventListener('change', checkDuplicateLabors);

                container.appendChild(newForm);
            })
            .catch(error => console.error('Error:', error));
    }

    function checkDuplicateMaterials(event) {
        const selectedMaterials = Array.from(document.querySelectorAll('select[name$="-material_choices"]')).map(select => select.value);
        const currentSelect = event.target;
        const currentValue = currentSelect.value;

        // 检查是否有重复项
        const isDuplicate = selectedMaterials.filter(value => value === currentValue).length > 1;
        if (isDuplicate) {
            alert('不能添加相同的材料');
            currentSelect.value = ""; // 重置选择框
        }
    }

    function checkDuplicateLabors(event) {
        const selectedLabors = Array.from(document.querySelectorAll('select[name$="-labor_choices"]')).map(select => select.value);
        const currentSelect = event.target;
        const currentValue = currentSelect.value;

        // 检查是否有重复项
        const isDuplicate = selectedLabors.filter(value => value === currentValue).length > 1;
        if (isDuplicate) {
            alert('不能添加相同的工序');
            currentSelect.value = ""; // 重置选择框
        }
    }
    
    function removeForm(button) {
        button.closest('.form-row').remove();
    }
</script>
{% endblock %}
