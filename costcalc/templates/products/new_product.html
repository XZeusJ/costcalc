{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h3>新增产品</h3>
    <hr />
    
    <form method="post" action="{{ url_for('products.new_product') }}" id="product-form">
        {{ form.hidden_tag() }}

        <!-- 产品名称字段 -->
        <div class="form-row">
            <div class="form-group col-md-2">
                <h5>{{ form.name.label(class="form-label") }}</h5>
                {{ form.name(class="form-control") }}
            </div>
        </div>
        <hr />

        <!-- 动态材料表单 -->
        <div class="d-flex justify-content-between align-items-center my-3">
            <h5 class="mb-0">材料</h5>
            <button type="button" class="btn btn-primary btn-sm" id="add-material-btn">+</button>
        </div>
        <div id="materialforms-container"></div>
        <hr/>


        <!-- 动态人工表单 -->
        <div class="d-flex justify-content-between align-items-center my-3">
            <h5 class="mb-0">人工</h5>
            <button type="button" class="btn btn-primary btn-sm" id="add-labor-btn">+</button>
        </div>
        <div id="laborforms-container"></div>
        <hr />

        <!-- 运输费用字段 -->
        <h5>运输</h5>
        <div class="form-row">
            <div class="form-group col-md-2">
                {{ form.trans_method.label(class="form-label") }}
                {{ form.trans_method(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.trans_dest.label(class="form-label") }}
                {{ form.trans_dest(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.trans_cost_kg.label(class="form-label") }}
                {{ form.trans_cost_kg(class="form-control") }}
            </div>
        </div>
        <hr/>
        <!-- 系数字段 -->
        <h5>系数</h5>
        <div class="form-row">
            <div class="form-group col-md-2">
                {{ form.dev_coef.label(class="form-label") }}
                {{ form.dev_coef(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.fac_coef.label(class="form-label") }}
                {{ form.fac_coef(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.admin_coef.label(class="form-label") }}
                {{ form.admin_coef(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.sale_coef.label(class="form-label") }}
                {{ form.sale_coef(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.finance_coef.label(class="form-label") }}
                {{ form.finance_coef(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.tax_coef.label(class="form-label") }}
                {{ form.tax_coef(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.profit_coef.label(class="form-label") }}
                {{ form.profit_coef(class="form-control") }}
            </div>
        </div>
        <hr/>

        <!-- 定制化字段 -->
        <h5>定制化</h5>
        <div class="form-row">
            <div class="form-group col-md-2">
                {{ form.customer_type.label(class="form-label") }}
                {{ form.customer_type(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.payment_term.label(class="form-label") }}
                {{ form.payment_term(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.customer_importance.label(class="form-label") }}
                {{ form.customer_importance(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.estimated_purchase_amount.label(class="form-label") }}
                {{ form.estimated_purchase_amount(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.region_price.label(class="form-label") }}
                {{ form.region_price(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.customer_prospect.label(class="form-label") }}
                {{ form.customer_prospect(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.product_risk.label(class="form-label") }}
                {{ form.product_risk(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.technical_quality_requirement.label(class="form-label") }}
                {{ form.technical_quality_requirement(class="form-control") }}
            </div>
            <div class="form-group col-md-2">
                {{ form.customization_requirement.label(class="form-label") }}
                {{ form.customization_requirement(class="form-control") }}
            </div>
        </div>
     
        <hr />

        <!-- 提交按钮 -->
        <div class="col text-right">
            <button type="submit" class="btn btn-primary">提交</button>
        </div>
    </form>
</div>
{% endblock %}


{% block scripts %}
{{ super() }}
<script type="text/javascript">
    var new_productmaterialform_url = "{{ url_for('products.new_pmform') }}";
    var new_productlaborform_url = "{{ url_for('products.new_plform') }}";
</script>
<script>
    let formCounter = {
        material: 0,
        labor: 0
    };

    function addForm(type) {
        // 确定使用哪个URL
        const url = type === 'material' ? new_productmaterialform_url : new_productlaborform_url;
        const container = document.getElementById(`${type}forms-container`);

        fetch(url)
            .then(response => response.text())
            .then(html => {
                formCounter[type]++;
                const newForm = document.createElement('div');
                newForm.innerHTML = html.replace(/__prefix__/g, formCounter[type]);
                const newSelect = newForm.querySelector(`select[name$="-${type}_choices"]`);
                container.appendChild(newForm);
                initializeSelect2WithPlaceholder(newSelect, `Select a ${type}`);
            })
            .catch(error => console.error('Error:', error));
    }

    function initializeSelect2WithPlaceholder(newSelect, placeholderText) {
        const emptyOption = document.createElement('option');
        emptyOption.value = "";
        emptyOption.disabled = true;
        emptyOption.selected = true;
        emptyOption.hidden = true;

        newSelect.insertBefore(emptyOption, newSelect.firstChild);
        $(newSelect).select2({
            placeholder: placeholderText,
            allowClear: true,
            width: '100%'
        });
        // 打开时聚焦搜索框
        $(document).on('select2:open', () => {
            document.querySelector('.select2-search__field').focus();
        });
    }


    document.getElementById('add-material-btn').addEventListener('click', function() {
        addForm('material');
    });

    document.getElementById('add-labor-btn').addEventListener('click', function() {
        addForm('labor');
    });

    function removeForm(button) {
        button.closest('.form-row').remove();
    }

    // 新添加的检查重复函数和修改的表单提交事件
    function checkDuplicatesBeforeSubmit() {
        let values = [];
        let isDuplicate = false;

        // 检查所有 select 元素的选定值是否重复
        $('#materialforms-container select, #laborforms-container select').each(function() {
            const selectedText = $(this).find('option:selected').text();
            if (values.indexOf(selectedText) !== -1 && selectedText !== "") {
                isDuplicate = true;
                return false; // 有重复，终止循环
            }
            values.push(selectedText);
        });

        return isDuplicate;
    }

    $(document).ready(function() {
        $('#product-form').on('submit', function(e) {
            if (checkDuplicatesBeforeSubmit()) {
                e.preventDefault(); // 阻止表单提交
                alert('你有重复的材料/人工选项，请选择不同的材料/人工选项。');
            }
        });
    });
</script>
{% endblock %}
